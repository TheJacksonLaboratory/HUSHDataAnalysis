---
title: "Prednisone-association"
author: "Aaron Zhang"
date: "6/1/2018"
output: html_document
---

Data:
UNC HUSH+ data about ~15,000 patients who visited hospitals for asthma. All patients are assumed "sick" because they all visit hospitals for asthma symptoms. In another word, there are no healthy controls.

Goal:
Group patients into Severe, Non-Severe categories based on whether they are prescribed with prednison or not. Look at what HPO terms are associated with each category. 

```{r}
#load R libraries
library(dplyr)
library(ggplot2)
library(scales)
library(RSQLite)
```

First load the database that stores essential tables in UNC HUSH+ data
```{r}
db <- dbConnect(RSQLite::SQLite(), "/Users/zhangx/Documents/HUSH+_UNC_JAX/Hush+UNC_JAX/HUSH+_UNC_JAX.sqlite")
```
retrieve patient list
```{r}
patients <- dbGetQuery(db, "SELECT patient_num, birth_date, sex_cd FROM PATIENT_DIMENTION")
nrow(patients)
```
import patient prescribed with prednisone
```{r}
prednisonPrescribTimes <- read.csv("/Users/zhangx/Documents/HUSH+_UNC_JAX/Hush+UNC_JAX/HUSH+/patientPrednisonPrsbCount.txt", header = TRUE, sep = "\t");
```
import LOINC records mapped to HPO terms
```{r}
loinc2hpo <- read.csv("/Users/zhangx/Documents/HUSH+_UNC_JAX/Hush+UNC_JAX/HUSH+/loinc2hpotransformation.txt", header = TRUE, sep = "\t")
nrow(loinc2hpo)
```

combine tables together
```{r}
combined <- loinc2hpo %>%
  filter(mapFailed == "false") %>%
  select(patient_num, isNegated, hpoTerm) %>%
  distinct() %>%# it reduced records from 6 million records to < 0.6 million
  left_join(patients) %>%
  left_join(prednisonPrescribTimes)
nrow(combined)
```

define a helper function that convert boolean to strings
```{r}
boolString <- function(x) {
  newvec <- c()
  for (i in 1:length(x)) {
    if (x[i] == "true") {
      newvec <- c(newvec, "NOT")
    } else {
      newvec <- c(newvec, "")
    }
  }
  return (newvec)
}
```


For each HPO term, calculate how many patients on prednison have the term
```{r}
patientOnPrednisonCount <- combined %>%
  filter(!is.na(prscbCount)) %>% 
  group_by(isNegated, hpoTerm) %>% 
  select(patient_num, isNegated, hpoTerm, sex_cd) %>% 
  distinct(patient_num) %>% 
  summarise(count = n()) %>% 
  mutate(groupName = paste(boolString(isNegated), hpoTerm, sep = " ")) %>% 
  select(groupName, count)
```
For each HPO term, calculate how many patients not on prednison have the term
```{r}
patientNotOnPrednisonCount <- combined %>%
  filter(is.na(prscbCount)) %>% 
  group_by(isNegated, hpoTerm) %>% 
  select(patient_num, isNegated, hpoTerm, sex_cd) %>% 
  distinct(patient_num) %>% 
  summarise(count = n()) %>% 
  mutate(groupName = paste(boolString(isNegated), hpoTerm, sep = " ")) %>% 
  select(groupName, count)
```
create a table of patient counts per hpo term, with two columns w/t prednisone and w/ prednison
```{r}
patientCombinedCounts1 <- 
  data.frame(hpo = patientNotOnPrednisonCount$groupName, noPrednison = patientNotOnPrednisonCount$count)
patientCombinedCounts2 <- 
  data.frame(hpo = patientOnPrednisonCount$groupName, onPrednison = patientOnPrednisonCount$count)
patientCombinedCounts <- patientCombinedCounts1 %>% full_join(patientCombinedCounts2) %>%
  mutate(noPrednison = ifelse(is.na(noPrednison), 0, noPrednison), onPrednison = ifelse(is.na(onPrednison), 0, onPrednison))

populationCount <- c("ALLPATIENTS", nrow(patients) - nrow(prednisonPrescribTimes), nrow(prednisonPrescribTimes))

```

define a function to compute the p-value using chisq test whether patient counts with certain HPO term is associated with severity
```{r}
# x is patient counts with a certain hpo term, divided into noPrednison or onPrednisone
# Y is patient counts among all patients, divided into noPrednison or onPrednisone
pValueChisq <- function(x, Y) {
  M <- as.matrix(rbind(as.integer(x[c(2,3)]), as.integer(Y[c(2,3)])))
  M
  return (chisq.test(M)[[3]])
}
```

calculate the chisq test p value for all hpo terms and order by p

```{r}
pValVec = rep(-1, nrow(patientCombinedCounts))
for (i in 1:nrow(patientCombinedCounts)) {
  pValVec[i] <- pValueChisq(unlist(patientCombinedCounts[i,]), populationCount)
}
#patientCombinedCounts$pVal <- pValVec
patientCombinedCounts <- patientCombinedCounts %>%  mutate(pVal = pValVec) %>% arrange(pVal)
```


Disconnect database
```{r}
dbDisconnect(db)
```



