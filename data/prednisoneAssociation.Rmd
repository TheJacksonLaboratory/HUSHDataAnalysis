---
title: "Prednisone-association"
author: "Aaron Zhang"
date: "6/1/2018"
output: html_document
---

Data:
UNC HUSH+ data about ~15,000 patients who visited hospitals for asthma. All patients are assumed "sick" because they all visit hospitals for asthma symptoms. In another word, there are no healthy controls.

Goal:
Group patients into Severe, Non-Severe categories based on whether they are prescribed with prednison or not. Look at what HPO terms are associated with each category. 


define a helper function that convert boolean to strings
```{r}
boolString <- function(x) {
  newvec <- c()
  for (i in 1:length(x)) {
    if (x[i] == "true") {
      newvec <- c(newvec, "NOT ")
    } else {
      newvec <- c(newvec, "")
    }
  }
  return (newvec)
}
```

```{r}
#load R libraries
library(tidyverse)
library(scales)
library(RSQLite)
library(Rmpfr)
library(lubridate)
```

First load the database that stores essential tables in UNC HUSH+ data
```{r}
db <- dbConnect(RSQLite::SQLite(), "/Users/zhangx/Documents/HUSH+_UNC_JAX/Hush+UNC_JAX/HUSH+_UNC_JAX.sqlite")
```

retrieve patient list
import patient prescribed with prednisone
import patient no. hospital visits
  How do we count no. hospital visits for patients?
  For any day, if a patient has an encounter, we count the patient visit hospital once. 
import loinc2hpo transformation
```{r}
patients <- dbGetQuery(db, "SELECT patient_num, birth_date, sex_cd FROM PATIENT_DIMENTION")
prednisonPrescribTimes <- read.csv("/Users/zhangx/Documents/HUSH+_UNC_JAX/Hush+UNC_JAX/HUSH+/patientPrednisonPrsbCount.txt", header = TRUE, sep = "\t");
# replace na with 0
prednisonPrescribTimes <- prednisonPrescribTimes %>% mutate(prscbCount = ifelse(is.na(prscbCount), 0, prscbCount))
visitCount <- dbGetQuery(db, "SELECT V.patient_num, count(distinct(O.start_date)) AS encounter_no_days FROM VISIT_DIMENSION AS V LEFT JOIN OBSERVATION_FACT AS O ON V.encounter_num = O.encounter_num AND V.patient_num = O.patient_num GROUP BY V.patient_num ORDER BY encounter_no_days DESC")
loinc2hpo <- read.csv("/Users/zhangx/Documents/HUSH+_UNC_JAX/Hush+UNC_JAX/HUSH+/loinc2hpotransformation.txt", header = TRUE, sep = "\t")

#select patient subset with ICD codes for asthma
patient_withAsthmaICD <- dbGetQuery(db, "SELECT DISTINCT(patient_num) FROM ICD WHERE icd LIKE 'ICD9:493%' OR icd LIKE 'ICD10:J45%'")
allICDCodesForPatientWithAsthma <- dbGetQuery(db, "SELECT icd, COUNT(DISTINCT(patient_num)) AS count FROM ICD WHERE patient_num IN (SELECT DISTINCT(patient_num) FROM ICD WHERE icd LIKE 'ICD9:493%' OR icd LIKE 'ICD10:J45%') GROUP BY icd ORDER BY count DESC ;")
icd9_3_digit_codes <- read.csv("/Users/zhangx/git/HushToFhir/src/main/resources/icd9_ThreeDigitCodes.tsv", sep = "\t", header = TRUE, stringsAsFactors = FALSE, as.is = "character")
icd10_3_digit_codes <- read.csv("/Users/zhangx/git/HushToFhir/src/main/resources/icd10cm_ThreeDigitCodes.tsv", sep = "\t", header = TRUE, stringsAsFactors = FALSE, as.is = "character")
```

look at what other diagnosis codes do asthma patients have
```{r}
icd_3_digit_code_annotation <- 
  icd9_3_digit_codes %>% 
      mutate(icd = paste("ICD9", icd9code, sep = ":")) %>% 
      rename(descr = icd9descr) %>% 
      select(icd, descr) %>%
    bind_rows(
    icd10_3_digit_codes %>% 
      mutate(icd = paste("ICD10", icd10code, sep = ":")) %>% 
      rename(descr = icd10descr) %>% 
      select(icd, descr) 
    )

allDiagnosisCodesForAsthmaPatients <- allICDCodesForPatientWithAsthma %>% left_join(icd_3_digit_code_annotation) %>% select(icd, count, descr)

```
```{r}
write.table(allDiagnosisCodesForAsthmaPatients, "/Users/zhangx/git/HushToFhir/data/allDiagnosisCodesForAsthmaPatients.tsv", sep = "\t", quote = FALSE)
```


calculating statistics:

1. determine how many LOINC code are mapped to each HPO term from the annotation file
```{r}
loincAnnotationStat <- read.csv("/Users/zhangx/git/HushToFhir/data/loincAnnotationstats.tsv", header = TRUE, sep = "\t")
loincAnnotationStat <- loincAnnotationStat %>% mutate(hpo = as.character(hpo), loincMappedTo = loincCounts) %>% select(hpo, loincMappedTo)
```

  count the percentage of LOINC tests that can be successfully mapped to an HPO
```{r}
loinc2hpo %>% select(mapFailed, encounter_num, patient_num, concept_cd, start_date) %>% group_by(mapFailed) %>% summarise(counts = n()) %>%
  ggplot() + geom_bar(aes(x = 1, y = counts / sum(counts), fill = mapFailed), stat = "identity",  width = 1) + coord_polar(theta = "y") +
  scale_fill_manual(name = "lab test to HPO\nconversion", breaks = c("false", "true"), labels = c("success", "fail"), values = c("green", "red")) + 
  xlab("") + ylab("") + theme_bw() +
  theme(panel.grid = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), legend.position = c(0.1, 0.8), legend.background = element_blank(), panel.border = element_blank(), legend.text = element_text(size = 8), legend.title = element_text(size = 10)) 

ggsave("~/Desktop/Hush lab test to HPO conversion.png", width = 2.5, height = 2.5)
```

  count the number of total HPO mapped to each patient, and total of unique HPO mapped to each HPO
  
```{r}
loinc2hpo %>% select(mapFailed, patient_num, hpoTerm) %>% 
  filter(mapFailed == "false") %>% 
  group_by(patient_num) %>% summarise(counts = n()) %>%
  ggplot() + geom_histogram(aes(counts), binwidth = 500) + xlab("no. of HPO terms per patient") + ylab("patient Counts") + scale_x_continuous(limits = c(-500, 8000), breaks = seq(0, 8000, by = 2000)) + 
  theme_bw() + theme(panel.grid = element_blank(), axis.title = element_text(size = 10), axis.text = element_text(size = 8))
ggsave("~/HPO term counts for each patient.png", width = 2.5, height = 2)

loinc2hpo %>% select(mapFailed, patient_num, hpoTerm) %>% 
  filter(mapFailed == "false") %>%
  distinct() %>%
  group_by(patient_num) %>% 
  summarise(counts = n()) %>%
  ggplot() + geom_histogram(aes(counts), binwidth = 10) + xlab("no. of unique HPO terms per patient") + ylab("patient Counts") +
  theme_bw() + theme(panel.grid = element_blank(), axis.title = element_text(size = 10), axis.text = element_text(size = 8))
ggsave("~/unique HPO term counts for each patient.png", width = 3, height = 2)
```

2. determine how many LOINC codes are aggregated for each HPO term
   then determine how many times a patient is mapped to the same hpo term
```{r}
loincAggregated <- loinc2hpo %>%
  filter(mapFailed == "false") %>%
  select(concept_cd, hpoTerm) %>%
  distinct() %>%
  group_by(hpoTerm) %>%
  mutate(loincAggrgtdFrom = n()) %>%
  ungroup() %>%
  mutate(hpo = as.character(hpoTerm)) %>%
  select(hpo, loincAggrgtdFrom) %>%
  distinct()

patientTermMapFreq <- loinc2hpo %>% 
  filter(mapFailed == "false") %>%
  select(patient_num, isNegated, hpoTerm) %>% #6,359,143 lines of records
  #count()
  group_by(patient_num, isNegated, hpoTerm) %>% # for each patient and each term, count how many times the term is diagnosed with a test
  summarise(hpoTermFreq = n()) %>%
  ungroup() #572,497 lines of records ---->>> a patient is frequenctly mapped to the same HPO term!
  #count()
```

3. combine tables together
skip patients without any HPO terms
also skip HPO terms for unknown patients
```{r}
patient_withAsthmaICD <- patient_withAsthmaICD %>% mutate(withAsthmaICDCode = "Y")
patient_lastVisit <- loinc2hpo %>% select(patient_num, start_date) %>% group_by(patient_num) %>% summarise(lastVisit = max(as.Date(start_date)))

patient_withDiabetes <- dbGetQuery(db, "SELECT DISTINCT(patient_num) FROM ICD WHERE icd LIKE 'ICD9:250%' OR icd LIKE 'ICD10:E11%'") %>%  mutate(withDiabeteICDCode = "Y")
patient_withChronicLiverDamage <- dbGetQuery(db, "SELECT DISTINCT(patient_num) FROM ICD WHERE icd = 'ICD10:N18' OR icd = 'ICD9:585'") %>% mutate(withChronicLiverDamageICDCode = "Y")

combined <- patients %>%
  inner_join(patientTermMapFreq, by = "patient_num") %>%
  left_join(visitCount) %>%
  left_join(prednisonPrescribTimes) %>%
  left_join(patient_withAsthmaICD) %>%
  left_join(patient_withDiabetes) %>% # add diabete label
  left_join(patient_withChronicLiverDamage) %>% # add chronic liver damage label
  left_join(patient_lastVisit) %>%
  mutate(prscbCount = ifelse(is.na(prscbCount), 0, prscbCount)) %>%
  mutate(withAsthmaICDCode = ifelse(is.na(withAsthmaICDCode), "N", "Y")) %>%
  mutate(withDiabeteICDCode = ifelse(is.na(withDiabeteICDCode), "N", "Y")) %>%
  mutate(withChronicLiverDamageICDCode = ifelse(is.na(withChronicLiverDamageICDCode), "N", "Y"))
nrow(combined)

#spread it to a matrix for machine learning
df4ML <- combined %>% filter(isNegated == "false") %>% 
  mutate(hpoTermPresent = ifelse(hpoTermFreq >= 3, 1, 0)) %>% 
  select(-hpoTermFreq) %>%
  spread(key = hpoTerm, value = hpoTermPresent, fill = 0) %>% 
  mutate (isSevere = ifelse(prscbCount >= 3, 1, 0)) %>%
  mutate(age = round(as.duration(interval(birth_date, lastVisit))/dyears(1), 1)) %>%
  select(-c(birth_date, lastVisit, isNegated, prscbCount)) %>%
  select(patient_num, sex_cd, age, everything())
```

For each HPO term, calculate how many patients on prednison have the term
We define a threshold for the number of times a patient visits hospitals. If the visits count is less than the threshold, ignore those patients.
```{r}
VISITTIMES_THRESHOLD = 10  
SEVERITY_THRESHOLD = 3
TERMFREQ_THRESHOLD = 3
  
patientConditionalCounts <- function(data = combined, hasAsthma = FALSE, hasDiabetes = FALSE, hasChronicLiverDamages = FALSE) {
  
  ASTHMA_CONDITION = ifelse(hasAsthma, "Y", "N")
  DIABETES_CONDITION = ifelse(hasDiabetes, "Y", "N")
  CHRONIC_LIVER_DAMAGES_CONDITION = ifelse(hasChronicLiverDamages, "Y", "N")
  
  return (data %>% 
  filter(encounter_no_days >= VISITTIMES_THRESHOLD) %>% #ignore patients that only occationally visited hospitals
  filter(withAsthmaICDCode == ASTHMA_CONDITION) %>% #ignore patients that is not diagnosed with asthma
  filter(withDiabeteICDCode == DIABETES_CONDITION) %>% #ignore patients that have been diagnosed with diabetes
  filter(withChronicLiverDamageICDCode == CHRONIC_LIVER_DAMAGES_CONDITION) %>% # ignore patients that have been diagnosed with chronic liver damage
  filter(hpoTermFreq >= TERMFREQ_THRESHOLD) %>%
  mutate(severity = ifelse(prscbCount > SEVERITY_THRESHOLD, "severe", "nonSevere")) %>%
  group_by(isNegated, hpoTerm, severity) %>%
  summarise(count = n()) %>%
  spread(key = severity, value = count, fill = 0) %>%
  ungroup() %>%
  mutate(hpo = paste(boolString(isNegated), hpoTerm, sep = "")) %>%
  select(hpo, nonSevere, severe))
  
}
  
patientCombinedCounts_1 <- patientConditionalCounts(combined, hasAsthma = FALSE, hasDiabetes = FALSE, hasChronicLiverDamages = FALSE)
patientCombinedCounts_2 <- patientConditionalCounts(combined, hasAsthma = TRUE, hasDiabetes = FALSE, hasChronicLiverDamages = FALSE)

```


Calculate population distribution
```{r}
populationCount <- function(data = combined, hasAsthma = FALSE, hasDiabetes = FALSE, hasChronicLiverDamages = FALSE) {
  ASTHMA_CONDITION = ifelse(hasAsthma, "Y", "N")
  DIABETES_CONDITION = ifelse(hasDiabetes, "Y", "N")
  CHRONIC_LIVER_DAMAGES_CONDITION = ifelse(hasChronicLiverDamages, "Y", "N")
  
  return (combined %>%
  filter(withAsthmaICDCode == ASTHMA_CONDITION) %>%
  filter(withDiabeteICDCode == DIABETES_CONDITION) %>%
  filter(withChronicLiverDamageICDCode == CHRONIC_LIVER_DAMAGES_CONDITION) %>%
  select(patient_num, prscbCount) %>% distinct() %>% mutate(severity = ifelse(prscbCount >= SEVERITY_THRESHOLD, "severity", "nonSevere")) %>% select(-prscbCount) %>% group_by(severity) %>% summarise(count = n()))
}

populationCount_1 <- populationCount(combined, hasAsthma = FALSE, hasDiabetes = FALSE, hasChronicLiverDamages = FALSE) 
populationCount_2 <- populationCount(combined, hasAsthma = TRUE, hasDiabetes = FALSE, hasChronicLiverDamages = FALSE) 

# prednisonPrescribTimes <- prednisonPrescribTimes %>%
#   left_join(visitCount)
# severePatientCount <- prednisonPrescribTimes %>%filter(encounter_no_days > VISITTIMES_THRESHOLD) %>% filter(prscbCount > SEVERITY_THRESHOLD) %>% count()
# #totalPatient <- nrow(patients)
# totalPatient <- patients %>% 
#   left_join(visitCount) %>%
#   filter(encounter_no_days > VISITTIMES_THRESHOLD) %>%
#   count()
# populationCount <- c("ALLPATIENTS", totalPatient - severePatientCount, severePatientCount)
```

define a function to compute the p-value using chisq test whether patient counts with certain HPO term is associated with severity
```{r}
# x is patient counts with a certain hpo term, divided into noPrednison or onPrednisone
# Y is patient counts among all patients, divided into non-severe and severe groups. The function will use those value to calculate patient counts not belonging to x
pValueChisq <- function(x, Y) {
  M <- as.matrix(rbind(as.integer(x[c(2,3)]), Y))
  M[2,] <- M[2,] - M[1,]
  return (chisq.test(M)[[3]])
}
```

This function calculate whether sample x fits population Y
```{r}
pValueChisqFitness <- function(x, Y) {
  p <- Y/sum(Y)
  return (chisq.test(as.integer(x[c(2,3)]), y = NULL, p)[[3]])
}
```


calculate the chisq test p value for all hpo terms and order by p

```{r}

outcome <- function(patientCombinedCounts, populationCount) {
  pValVec = rep(-1, nrow(patientCombinedCounts))
  for (i in 1:nrow(patientCombinedCounts)) {
    pValVec[i] <- pValueChisq(unlist(patientCombinedCounts[i,]), populationCount$count)
  }
  patientCombinedCounts$pVal <- pValVec
  return( patientCombinedCounts %>% 
    #rename(hpo = groupName) %>%
    mutate(`notSeverePatientNo(%)` = paste(nonSevere, "[", round(100 * nonSevere/populationCount$count[1], 1), "]", sep = "")) %>%
    mutate(nonSeverePercent = nonSevere/populationCount$count[1]) %>%
    mutate(`severePatientNo(%)` = paste(severe, "[", round(100 * severe/populationCount$count[2], 1), "]", sep = "")) %>%
    mutate(severePercent = severe/populationCount$count[2]) %>%
    filter(!startsWith(hpo, "NOT")) %>% 
    left_join(loincAggregated) %>%
    left_join(loincAnnotationStat) %>%
    select(hpo, mappedTo = loincMappedTo, aggrgtdFrom = loincAggrgtdFrom, `notSeverePatientNo(%)`, nonSeverePercent, `severePatientNo(%)`, severePercent, pVal) %>% 
    arrange(pVal))
}

outcome_1 <- outcome(patientCombinedCounts_1, populationCount_1)
outcome_1_display <- outcome_1 %>% select(-nonSeverePercent, -severePercent)
outcome_2 <- outcome(patientCombinedCounts_2, populationCount_2)
outcome_2_display <- outcome_2 %>% select(-nonSeverePercent, -severePercent)

View(df4ML)
View(outcome_1_display)
```


```{r}
write.csv(df4ML, "Hush+_data_matrix.csv", quote = FALSE)
write.csv(outcome, "patientCombinedCounts.csv", quote = FALSE)
```

```{r}
asthmaNoDiabetesNoLiverDamage <- outcome_2
noasthmaNoDiabetesNoLiverDamage <- outcome_1
joined_data <- asthmaNoDiabetesNoLiverDamage %>% mutate(foldchange_asthma = severePercent/nonSeverePercent, significe_asthma = ifelse(pVal > 0.001, "N", "Y")) %>% select(hpo, foldchange_asthma, significe_asthma) %>% full_join(
  noasthmaNoDiabetesNoLiverDamage  %>% mutate(foldchange_no_asthma = severePercent/nonSeverePercent, significance_no_asthma = ifelse(pVal > 0.001, "N", "Y")) %>% select(hpo, foldchange_no_asthma, significance_no_asthma))

significance_group <- c("asthma group", "non-asthma group", "both group", "neither group")
significance_level <- c("asthma group", "non-asthma group", "both group", "neither group")

joined_data %>% na.omit() %>%  
  mutate(significance = ifelse(significe_asthma == "Y" & significance_no_asthma == "N", significance_group[1], ifelse(significe_asthma == "N" & significance_no_asthma == "Y", significance_group[2], ifelse(significe_asthma == "Y" & significance_no_asthma == "Y", significance_group[3], significance_group[4])))) %>% 
  mutate(tolabel = ifelse(significance == significance_group[1], hpo, ifelse(foldchange_asthma/foldchange_no_asthma  < 0.25 & significance != significance_group[4], hpo, "")))%>%
  ggplot() + geom_point(aes(x = foldchange_no_asthma, y = foldchange_asthma, shape = factor(significance, levels = significance_level), color = factor(significance, levels = significance_level), size = factor(significance, levels = significance_level))) + geom_text(aes(x = foldchange_no_asthma, y = foldchange_asthma, label = ""), size = 3, vjust = -1, hjust = -0.05) + coord_fixed(ratio = 1) + 
  scale_shape_manual(name = "", values = c(3, 4, 18, 16)) + scale_color_manual(name = "", values=c("red",  "blue", "orange", "black")) + scale_size_manual(name = "", values=c(3, 3, 2, 1)) +  xlab("HPO-dependent odds raio of being severe -asthma") + ylab("HPO-dependent odds raio of being severe +asthma") + theme_bw() + theme(panel.grid = element_blank(), legend.position = "none", legend.background = element_blank()) + geom_abline(intercept = 0, slope = 1, size = 0.5, color = "gray") + scale_y_continuous(limits = c(0, 50)) + scale_x_continuous(limits = c(0, 50))

joined_data %>% na.omit() %>%  
  mutate(significance = ifelse(significe_asthma == "Y" & significance_no_asthma == "N", significance_group[1], ifelse(significe_asthma == "N" & significance_no_asthma == "Y", significance_group[2], ifelse(significe_asthma == "Y" & significance_no_asthma == "Y", significance_group[3], significance_group[4])))) %>% 
  mutate(tolabel = ifelse(significance == significance_group[1], hpo, ifelse(foldchange_asthma/foldchange_no_asthma  < 0.25 & significance != significance_group[4], hpo, "")))%>%
  ggplot() + geom_point(aes(x = foldchange_no_asthma, y = foldchange_asthma, shape = factor(significance, levels = significance_level), color = factor(significance, levels = significance_level), size = factor(significance, levels = significance_level))) + geom_text(aes(x = foldchange_no_asthma, y = foldchange_asthma, label = tolabel), size = 3, vjust = -1, hjust = -0.05) + coord_fixed(ratio = 1) + 
  scale_shape_manual(name = "significance", values = c(3, 4, 18, 16)) + scale_color_manual(name = "significance", values=c("red",  "blue", "orange", "black")) + scale_size_manual(name = "significance", values=c(3, 3, 2, 1)) +  xlab("HPO-dependent odds raio of being severe -asthma") + ylab("HPO-dependent odds raio of being severe +asthma") + theme_bw() + theme(panel.grid = element_blank(), legend.position = c(0.2, 0.8), legend.background = element_blank()) + geom_abline(intercept = 0, slope = 1, size = 0.5, color = "gray") + scale_y_continuous(limits = c(0, 10)) + scale_x_continuous(limits = c(0, 10))

```

```{r}
visitAndSeverity <- visitCount %>% left_join(prednisonPrescribTimes) %>% 
  mutate (prscbCount = ifelse(is.na(prscbCount), 0, prscbCount)) %>% 
  mutate(severity = ifelse(prscbCount >= SEVERITY_THRESHOLD, "severe", "nonSevere"))

ggplot(visitAndSeverity) + geom_histogram(aes(x = encounter_no_days, group = severity, fill = severity), position = "stack" ,color = "black", binwidth = 20) + scale_x_continuous(limits = c(0, 500))



+
  geom_bar(aes(x = encounter_no_days, y = 400), stat = "identity")

```
```{r}
ggplot(visitAndSeverity) + geom_histogram(aes(x = encounter_no_days) ,color = "black", binwidth = 20) + scale_x_continuous(limits = c(0, 500))
```






Disconnect database
```{r}
dbDisconnect(db)
```



