---
title: "R Notebook"
output: html_notebook
---


```{r setup}
knitr::opts_knit$set(root.dir = "~/git/HushToFhir/")
```

Statistics of the loinc2hpo annotation file

```{r}
library(tidyverse)
```

load the annotation file
```{r}
annotationFile <- read.csv("/Users/zhangx/git/loinc2hpoAnnotation/Data/TSVSingleFile/annotations.tsv", sep = "\t")
```


distribution of annotatio LOINC types

```{r}
loincTypes <- annotationFile %>% select(loincId, loincScale) %>% distinct()
ggplot(loincTypes) + 
  geom_bar(aes(factor(loincScale, levels = c("Qn", "Ord", "Nom", "Unknown")), ..count../sum(..count..)), fill = "black") +
  xlab("LOINC type") + ylab("percentage")  +
  scale_x_discrete(breaks = c("Qn", "Ord", "Nom", "Unknown"), labels = c("Qn", "Ord", "Nom", "Panel"))+ theme_bw() +
  theme(panel.grid = element_blank(), axis.text = element_text(size = 8), axis.title = element_text(size = 8)) + 
  scale_y_continuous(labels = scales::percent)
loincTypes %>% group_by(loincScale) %>% summarise(no = n()) %>% mutate(percentage = no/sum(no))
```
```{r}
ggsave("./data/images/annotatedLoincDistribution.png", width = 1.8, height = 2)
```

count the total number of HPO terms
```{r}
annotationFile %>% select(hpoTermId) %>% distinct() %>% count()
noOfLOINCsMappedToEachHPO <- annotationFile %>% select(loincId, hpoTermId) %>% distinct() %>% group_by(hpoTermId) %>% mutate(noLoinc = n()) %>% ungroup() %>% select(hpoTermId, noLoinc) %>% distinct() 

ggplot(noOfLOINCsMappedToEachHPO) + geom_histogram(aes(x = noLoinc, y = ..count.. / sum (..count..)), fill = "black", binwidth =1) + 
  scale_y_continuous(labels = scales::percent) +
  #scale_x_continuous(limits = c(0, 40)) +  #skip the 200 extreme case
  xlab("number of distinct LOINC codes mapped to the same HPO terms") + ylab("frequency") + theme_bw() +
  theme(panel.grid = element_blank(), axis.text = element_text(size = 8), axis.title = element_text(size = 8), panel.border = element_rect(size = 0.75)) + scale_x_reverse() + coord_flip()
ggsave("./data/images/distribution of no. of LOINCs mapped to each HPO.png", width = 4, height = 2)

HPO_10 = noOfLOINCsMappedToEachHPO %>% filter(noLoinc == 10) %>% select(hpoTermId) %>% unlist() %>% as.character() %>% str_c(collapse = "\n")

ggplot(noOfLOINCsMappedToEachHPO) + geom_histogram(aes(x = noLoinc, y = ..count../sum(..count..)), fill = "black", binwidth = 1) + geom_label(aes(x = 10, y = 0.3, label = str_c("aggregation factor = 10", HPO_10, sep = "\n")), size = 2) +
  scale_y_continuous(labels = scales::percent)+
  scale_x_continuous(limits = c(18, 0), trans = "reverse") +
  xlab("HPO aggregation factor ") + ylab("frequency of HPO terms") + theme_bw() +
  theme(panel.grid = element_blank(), axis.text = element_text(size = 8), axis.title = element_text(size = 8), panel.border = element_rect(size = 0.75)) + coord_flip()

ggsave("./data/images/distribution of HPO terms.png", width = 2, height = 2)

```

