---
title: "Prednisone-association"
author: "Aaron Zhang"
date: "6/1/2018"
output: html_document
---
```{r}
setwd("~/git/HushToFhir/")
```

Data:
UNC HUSH+ data about ~15,000 patients who visited hospitals for asthma. All patients are assumed "sick" because they all visit hospitals for asthma symptoms. In another word, there are no healthy controls.

Goal:
Group patients into Severe, Non-Severe categories based on whether they are prescribed with prednison or not. Look at what HPO terms are associated with each category. 


define a helper function that convert boolean to strings
```{r}
boolString <- function(x) {
  newvec <- c()
  for (i in 1:length(x)) {
    if (x[i] == "true") {
      newvec <- c(newvec, "NOT ")
    } else {
      newvec <- c(newvec, "")
    }
  }
  return (newvec)
}
```

```{r}
#load R libraries
library(tidyverse)
library(scales)
library(RSQLite)
library(Rmpfr)
library(lubridate)
```

First load the database that stores essential tables in UNC HUSH+ data
```{r}
db <- dbConnect(RSQLite::SQLite(), "/Users/zhangx/Documents/HUSH+_UNC_JAX/Hush+UNC_JAX/HUSH+_UNC_JAX.sqlite")
```

retrieve patient list
import patient prescribed with prednisone
import patient no. hospital visits
  How do we count no. hospital visits for patients?
  For any day, if a patient has an encounter, we count the patient visit hospital once. 
import loinc2hpo transformation
```{r}
patients <- dbGetQuery(db, "SELECT patient_num, birth_date, sex_cd FROM PATIENT_DIMENTION")
prednisonPrescribTimes <- read.csv("/Users/zhangx/Documents/HUSH+_UNC_JAX/Hush+UNC_JAX/HUSH+/patientPrednisonPrsbCount.txt", header = TRUE, sep = "\t");
# replace na with 0
prednisonPrescribTimes <- prednisonPrescribTimes %>% mutate(prscbCount = ifelse(is.na(prscbCount), 0, prscbCount))
visitCount <- dbGetQuery(db, "SELECT V.patient_num, count(distinct(O.start_date)) AS encounter_no_days FROM VISIT_DIMENSION AS V LEFT JOIN OBSERVATION_FACT AS O ON V.encounter_num = O.encounter_num AND V.patient_num = O.patient_num GROUP BY V.patient_num ORDER BY encounter_no_days DESC")
loinc2hpo <- read.csv("/Users/zhangx/Documents/HUSH+_UNC_JAX/Hush+UNC_JAX/HUSH+/loinc2hpotransformation8-2-2018.txt", header = TRUE, sep = "\t")

#select patient subset with ICD codes for asthma
patient_withAsthmaICD <- dbGetQuery(db, "SELECT DISTINCT(patient_num) FROM ICD WHERE icd LIKE 'ICD9:493%' OR icd LIKE 'ICD10:J45%'")
allICDCodesForPatientWithAsthma <- dbGetQuery(db, "SELECT icd, COUNT(DISTINCT(patient_num)) AS count FROM ICD WHERE patient_num IN (SELECT DISTINCT(patient_num) FROM ICD WHERE icd LIKE 'ICD9:493%' OR icd LIKE 'ICD10:J45%') GROUP BY icd ORDER BY count DESC ;")
icd9_3_digit_codes <- read.csv("/Users/zhangx/git/HushToFhir/src/main/resources/icd9_ThreeDigitCodes.tsv", sep = "\t", header = TRUE, stringsAsFactors = FALSE, as.is = "character")
icd10_3_digit_codes <- read.csv("/Users/zhangx/git/HushToFhir/src/main/resources/icd10cm_ThreeDigitCodes.tsv", sep = "\t", header = TRUE, stringsAsFactors = FALSE, as.is = "character")
```

look at what other diagnosis codes do asthma patients have
```{r}
icd_3_digit_code_annotation <- 
  icd9_3_digit_codes %>% 
      mutate(icd = paste("ICD9", icd9code, sep = ":")) %>% 
      rename(descr = icd9descr) %>% 
      select(icd, descr) %>%
    bind_rows(
    icd10_3_digit_codes %>% 
      mutate(icd = paste("ICD10", icd10code, sep = ":")) %>% 
      rename(descr = icd10descr) %>% 
      select(icd, descr) 
    )

allDiagnosisCodesForAsthmaPatients <- allICDCodesForPatientWithAsthma %>% left_join(icd_3_digit_code_annotation) %>% select(icd, count, descr)

```
```{r}
write.table(allDiagnosisCodesForAsthmaPatients, "/Users/zhangx/git/HushToFhir/data/allDiagnosisCodesForAsthmaPatients.tsv", sep = "\t", quote = FALSE)
```


calculating statistics:

1. determine how many LOINC code are mapped to each HPO term from the annotation file
```{r}
loinc2hpoAnnotationFile <- read.csv("/Users/zhangx/git/loinc2hpoAnnotation/Data/TSVSingleFile/annotations.tsv", sep = "\t", stringsAsFactors = FALSE, header = TRUE)
loinc2hpoAnnotationFile %>% select(loincId, loincScale) %>% distinct() %>% 
  group_by(loincScale) %>%
  summarise(counts = n()) %>% 
  arrange(desc(counts)) %>%
  View()


#loincAnnotationStat <- loinc2hpoAnnotationFile %>% select(loincId, hpoTermId) %>% distinct() %>% group_by(hpoTermId) %>%
#  summarise(counts = n()) %>% arrange(desc(counts))
#mean(loincAnnotationStat$counts)
#quantile(loincAnnotationStat$counts)
#sum(loincAnnotationStat$counts >=2) / length(loincAnnotationStat$counts)

loincAnnotationStat <- read.csv("/Users/zhangx/git/HushToFhir/data/loincAnnotationstats8-2-2018.tsv", header = TRUE, sep = "\t")
loincAnnotationStat <- loincAnnotationStat %>% mutate(hpo = as.character(hpo), loincMappedTo = loincCounts) %>% select(hpo, loincMappedTo)

mean(loincAnnotationStat$loincMappedTo)
quantile(loincAnnotationStat$loincMappedTo)
sum(loincAnnotationStat$loincMappedTo >=2) / length(loincAnnotationStat$loincMappedTo)
```

  count the percentage of LOINC tests that can be successfully mapped to an HPO
```{r}

successRate <- sum(loinc2hpo$mapFailed == "false")/nrow(loinc2hpo)
print(paste("loinc2hpo conversion rate: ", round(successRate, 3) * 100, "%", sep = ""))

loinc2hpo %>% select(mapFailed, encounter_num, patient_num, concept_cd, start_date) %>% group_by(mapFailed) %>% summarise(counts = n()) %>%
  ggplot() + geom_bar(aes(x = 1, y = counts / sum(counts), fill = mapFailed), stat = "identity",  width = 1) + coord_polar(theta = "y") +
  scale_fill_manual(name = "lab test to HPO\nconversion", breaks = c("false", "true"), labels = c("success", "fail"), values = c("green", "red")) + 
  xlab("") + ylab("lab test to hpo conversion") + theme_bw() +
  theme(panel.grid = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), legend.position = c(0.0, 0.92), legend.background = element_blank(), panel.border = element_blank(), legend.text = element_text(size = 8), legend.title = element_blank(), legend.key.size = unit(0.25, "line"), axis.title = element_text(size = 8)) 

ggsave("~/Desktop/Hush lab test to HPO conversion.png", width = 0.8, height = 0.8)
```

  count the number of total HPO mapped to each patient, and total of unique HPO mapped to each HPO
  
```{r}
hpoTermCountsWithDuplicationPerPatient <- loinc2hpo %>% select(mapFailed, patient_num, hpoTerm) %>% 
  filter(mapFailed == "false") %>% 
  group_by(patient_num) %>% summarise(counts = n())  %>% ungroup()

no.HPOperPatient = sum(hpoTermCountsWithDuplicationPerPatient$counts) / nrow(patients)
print(paste("average no. of HPO terms per patient: ", round(no.HPOperPatient, 1), sep = ""))

  ggplot(hpoTermCountsWithDuplicationPerPatient) + geom_histogram(aes(counts), binwidth = 500) + xlab("no. of HPO terms\nper patient") + ylab("patient Counts") + scale_x_continuous(limits = c(-500, 8000), breaks = seq(0, 8000, by = 2000)) + 
  theme_bw() + theme(panel.grid = element_blank(), axis.title = element_text(size = 10), axis.text = element_text(size = 8), axis.ticks = element_line(size = 0.1), axis.ticks.length = unit(0.1, "line"), panel.border = element_rect(size = 0.25), panel.background = element_blank(), axis.title.y = element_text(vjust = -2), axis.title.x= element_text(vjust = 2))
ggsave("~/Desktop/HPO term counts for each patient.png", width = 0.8, height = 0.8 )

uniqueHPOperPatient <- loinc2hpo %>% select(mapFailed, patient_num, hpoTerm) %>% 
  filter(mapFailed == "false") %>%
  distinct() %>%
  group_by(patient_num) %>% 
  summarise(counts = n()) %>%ungroup()
no.uniqueHPOperPatient = sum(uniqueHPOperPatient$counts) / nrow(patients)
print(paste("average no. of unique HPO terms per patient: ", round(no.uniqueHPOperPatient, 1), sep = ""))

  ggplot(uniqueHPOperPatient) + geom_histogram(aes(counts), binwidth = 10) + xlab("no. of unique HPO\nterms per patient") + ylab("patient Counts") +
  theme_bw() + theme(panel.grid = element_blank(), axis.title = element_text(size = 10), axis.text = element_text(size = 8), axis.ticks = element_line(size = 0.1), axis.ticks.length = unit(0.1, "line"), panel.border = element_rect(size = 0.25), panel.background = element_blank(), axis.title.y = element_text(vjust = -2), axis.title.x= element_text(vjust = 2))
ggsave("~/Desktop/unique HPO term counts for each patient.png", width = 0.8, height = 0.8)
```

2. determine how many LOINC codes are aggregated for each HPO term
   then determine how many times a patient is mapped to the same hpo term
```{r}
loincAggregated <- loinc2hpo %>%
  filter(mapFailed == "false") %>%
  select(concept_cd, hpoTerm) %>%
  distinct() %>%
  group_by(hpoTerm) %>%
  mutate(loincAggrgtdFrom = n()) %>%
  ungroup() %>%
  mutate(hpo = as.character(hpoTerm)) %>%
  select(hpo, loincAggrgtdFrom) %>%
  distinct()

patientTermMapFreq <- loinc2hpo %>% 
  filter(mapFailed == "false") %>%
  select(patient_num, isNegated, hpoTerm) %>% #6,359,143 lines of records
  #count()
  group_by(patient_num, isNegated, hpoTerm) %>% # for each patient and each term, count how many times the term is diagnosed with a test
  summarise(hpoTermFreq = n()) %>%
  ungroup() #572,497 lines of records ---->>> a patient is frequenctly mapped to the same HPO term!
  #count()
```

3. combine tables together
skip patients without any HPO terms
also skip HPO terms for unknown patients
```{r}
patient_withAsthmaICD <- patient_withAsthmaICD %>% mutate(withAsthmaICDCode = "Y")
patient_lastVisit <- loinc2hpo %>% select(patient_num, start_date) %>% group_by(patient_num) %>% summarise(lastVisit = max(as.Date(start_date)))

patient_withDiabetes <- dbGetQuery(db, "SELECT DISTINCT(patient_num) FROM ICD WHERE icd LIKE 'ICD9:250%' OR icd LIKE 'ICD10:E11%'") %>%  mutate(withDiabeteICDCode = "Y")
patient_withChronicLiverDamage <- dbGetQuery(db, "SELECT DISTINCT(patient_num) FROM ICD WHERE icd = 'ICD10:N18' OR icd = 'ICD9:585'") %>% mutate(withChronicLiverDamageICDCode = "Y")

combined <- patients %>%
  inner_join(patientTermMapFreq, by = "patient_num") %>%
  left_join(visitCount) %>%
  left_join(prednisonPrescribTimes) %>%
  left_join(patient_withAsthmaICD) %>%
  left_join(patient_withDiabetes) %>% # add diabete label
  left_join(patient_withChronicLiverDamage) %>% # add chronic liver damage label
  left_join(patient_lastVisit) %>%
  mutate(prscbCount = ifelse(is.na(prscbCount), 0, prscbCount)) %>%
  mutate(withAsthmaICDCode = ifelse(is.na(withAsthmaICDCode), "N", "Y")) %>%
  mutate(withDiabeteICDCode = ifelse(is.na(withDiabeteICDCode), "N", "Y")) %>%
  mutate(withChronicLiverDamageICDCode = ifelse(is.na(withChronicLiverDamageICDCode), "N", "Y"))
nrow(combined)

patientTermMapFreq %>% filter(isNegated == "false") %>% select(-isNegated) %>% spread(key = hpoTerm, value = hpoTermFreq, fill = 0)
#spread it to a matrix for machine learning
df4ML <- combined %>% #filter(isNegated == "false", withDiabeteICDCode == "N", withChronicLiverDamageICDCode == "N", withAsthmaICDCode == "Y") %>% 
  filter(isNegated == "false") %>%
  #mutate(hpoTermPresent = ifelse(hpoTermFreq >= 3, 1, 0)) %>% 
  #select(-hpoTermFreq) %>%
  #spread(key = hpoTerm, value = hpoTermFreq, fill = 0) %>% 
  #spread(key = sex_cd, value = sex_cd) %>% 
  #mutate(F = ifelse(is.na(F), 0, 1), M = ifelse(is.na(M), 0, 1)) %>%
  #rename(female = F, male = M) %>%
  #distinct()
  spread(key = hpoTerm, value = hpoTermFreq, fill = 0) %>%
  #mutate (isSevere = ifelse(prscbCount >= 3, 1, 0)) %>%
  mutate(age = round(as.duration(interval(birth_date, lastVisit))/dyears(1), 1)) %>%
  select(-c(birth_date, lastVisit, isNegated)) %>%
  select(patient_num, age, everything()) %>%
  select(-prscbCount, prscbCount)
```

For each HPO term, calculate how many patients on prednison have the term
We define a threshold for the number of times a patient visits hospitals. If the visits count is less than the threshold, ignore those patients.
```{r}
VISITTIMES_THRESHOLD = 10  
SEVERITY_THRESHOLD = 4
TERMFREQ_THRESHOLD = 5
  
patientConditionalCounts <- function(data = combined, hasAsthma, hasDiabetes, hasChronicLiverDamages) {
  
  #ASTHMA_CONDITION = ifelse(hasAsthma, "Y", "N")
  #DIABETES_CONDITION = ifelse(hasDiabetes, "Y", "N")
  #CHRONIC_LIVER_DAMAGES_CONDITION = ifelse(hasChronicLiverDamages, "Y", "N")
  #ASTHMA_CONDITION = c("Y", "N")
  #DIABETES_CONDITION = c("Y", "N")
  #CHRONIC_LIVER_DAMAGES_CONDITION = c("Y", "N")
  if (missing(hasAsthma)) {
    ASTHMA_CONDITION <- c("Y", "N")
  } else if (hasAsthma) {
    ASTHMA_CONDITION <- c("Y")
  } else {
    ASTHMA_CONDITION <- c("N")
  }
  
  if (missing(hasDiabetes)) {
    DIABETES_CONDITION <- c("Y", "N")
  } else if (hasDiabetes) {
    DIABETES_CONDITION <- c("Y")
  } else {
    DIABETES_CONDITION <- c("N")
  }
  
  if (missing(hasChronicLiverDamages)) {
    CHRONIC_LIVER_DAMAGES_CONDITION <- c("Y", "N")
  } else if (hasChronicLiverDamages) {
    CHRONIC_LIVER_DAMAGES_CONDITION <- c("Y")
  } else {
    CHRONIC_LIVER_DAMAGES_CONDITION <- c("N")
  }
  #filters <- list(ASTHMA_CONDITION = vector(), 
  #                DIABETES_CONDITION = vector(), 
  #                CHRONIC_LIVER_DAMAGES_CONDITION = vector())
  
  patientsCounts <- data %>% 
  filter(encounter_no_days >= VISITTIMES_THRESHOLD) %>% #ignore patients that only occationally visited hospitals
  filter(is.element(withAsthmaICDCode, ASTHMA_CONDITION)) %>% #ignore patients that is not diagnosed with asthma
  filter(is.element(withDiabeteICDCode, DIABETES_CONDITION)) %>% #ignore patients that have been diagnosed with diabetes
  filter(is.element(withChronicLiverDamageICDCode, CHRONIC_LIVER_DAMAGES_CONDITION)) %>% # ignore patients that have been diagnosed with chronic liver damage
  filter(hpoTermFreq >= TERMFREQ_THRESHOLD) %>%
  mutate(severity = ifelse(prscbCount > SEVERITY_THRESHOLD, "severe", "nonSevere")) %>%
  group_by(isNegated, hpoTerm, severity) %>%
  summarise(count = n()) %>%
  spread(key = severity, value = count, fill = 0) %>%
  ungroup() %>%
  mutate(hpo = paste(boolString(isNegated), hpoTerm, sep = "")) %>%
  select(hpo, nonSevere, severe)
  
  # Calculate population distribution
  populationCounts <- combined %>%
  filter(is.element(withAsthmaICDCode, ASTHMA_CONDITION)) %>%
  filter(is.element(withDiabeteICDCode, DIABETES_CONDITION)) %>%
  filter(is.element(withChronicLiverDamageICDCode, CHRONIC_LIVER_DAMAGES_CONDITION)) %>%
  select(patient_num, prscbCount) %>% distinct() %>% mutate(severity = ifelse(prscbCount >= SEVERITY_THRESHOLD, "severity", "nonSevere")) %>% select(-prscbCount) %>% group_by(severity) %>% summarise(count = n())
  
  return(list(patientsCounts, populationCounts))
}
  
noAsthmaNoDiabetesNoCLD <- patientConditionalCounts(combined, hasAsthma = FALSE, hasDiabetes = FALSE, hasChronicLiverDamages = FALSE)
hasAsthmaNoDiabetesNoCLD <- patientConditionalCounts(combined, hasAsthma = TRUE, hasDiabetes = FALSE, hasChronicLiverDamages = FALSE)

noAsthma <- patientConditionalCounts(combined, hasAsthma = FALSE)
hasAsthma <- patientConditionalCounts(combined, hasAsthma = TRUE)
```


define a function to compute the p-value using chisq test whether patient counts with certain HPO term is associated with severity
```{r}
# x is patient counts with a certain hpo term, divided into noPrednison or onPrednisone
# Y is patient counts among all patients, divided into non-severe and severe groups. The function will use those value to calculate patient counts not belonging to x
pValueChisq <- function(x, Y) {
  M <- as.matrix(rbind(as.integer(x[c(2,3)]), Y))
  M[2,] <- M[2,] - M[1,]
  return (chisq.test(M)[[3]])
}
```

This function calculate whether sample x fits population Y
```{r}
pValueChisqFitness <- function(x, Y) {
  p <- Y/sum(Y)
  return (chisq.test(as.integer(x[c(2,3)]), y = NULL, p)[[3]])
}
```


calculate the chisq test p value for all hpo terms and order by p

```{r}

outcome <- function(patientCombinedCounts, populationCount) {
  pValVec = rep(-1, nrow(patientCombinedCounts))
  for (i in 1:nrow(patientCombinedCounts)) {
    pValVec[i] <- pValueChisq(unlist(patientCombinedCounts[i,]), populationCount$count)
  }
  patientCombinedCounts$pVal <- pValVec
  return( patientCombinedCounts %>% 
    #rename(hpo = groupName) %>%
    mutate(`notSeverePatientNo(%)` = paste(nonSevere, "[", round(100 * nonSevere/populationCount$count[1], 1), "]", sep = "")) %>%
    mutate(nonSeverePercent = nonSevere/populationCount$count[1]) %>%
    mutate(`severePatientNo(%)` = paste(severe, "[", round(100 * severe/populationCount$count[2], 1), "]", sep = "")) %>%
    mutate(severePercent = severe/populationCount$count[2]) %>%
    filter(!startsWith(hpo, "NOT")) %>% 
    left_join(loincAggregated) %>%
    left_join(loincAnnotationStat) %>%
    select(hpo, mappedTo = loincMappedTo, aggrgtdFrom = loincAggrgtdFrom, `notSeverePatientNo(%)`, nonSeverePercent, `severePatientNo(%)`, severePercent, pVal) %>% 
    arrange(pVal))
}

outcome_1 <- outcome(noAsthmaNoDiabetesNoCLD[[1]], noAsthmaNoDiabetesNoCLD[[2]])
outcome_1_display <- outcome_1 %>% select(-nonSeverePercent, -severePercent)
outcome_2 <- outcome(hasAsthmaNoDiabetesNoCLD[[1]], hasAsthmaNoDiabetesNoCLD[[2]])
outcome_2_display <- outcome_2 %>% select(-nonSeverePercent, -severePercent)

#outcome_1 <- outcome(noAsthma[[1]], noAsthma[[2]])
#outcome_2 <- outcome(hasAsthma[[1]], hasAsthma[[2]])
#View(df4ML)
#View(outcome_1_display)
```


```{r}
write.csv(df4ML, "./data/Hush+_data_matrix.csv", quote = FALSE, row.names = FALSE)
write.csv(rbind(outcome_1_display, outcome_2_display, deparse.level = 2), "patientCombinedCounts.csv", quote = FALSE, row.names = FALSE)
```

```{r}
asthmaNoDiabetesNoLiverDamage <- outcome_2
noasthmaNoDiabetesNoLiverDamage <- outcome_1
joined_data <- asthmaNoDiabetesNoLiverDamage %>% mutate(foldchange_asthma = severePercent/nonSeverePercent, significe_asthma = ifelse(pVal > 0.001, "N", "Y")) %>% select(hpo, foldchange_asthma, significe_asthma) %>% full_join(
  noasthmaNoDiabetesNoLiverDamage  %>% mutate(foldchange_no_asthma = severePercent/nonSeverePercent, significance_no_asthma = ifelse(pVal > 0.001, "N", "Y")) %>% select(hpo, foldchange_no_asthma, significance_no_asthma))

significance_group <- c("asthma group", "non-asthma group", "both group", "neither group")
significance_level <- c("asthma group", "non-asthma group", "both group", "neither group")

joined_data %>% na.omit() %>%  
  mutate(significance = ifelse(significe_asthma == "Y" & significance_no_asthma == "N", significance_group[1], ifelse(significe_asthma == "N" & significance_no_asthma == "Y", significance_group[2], ifelse(significe_asthma == "Y" & significance_no_asthma == "Y", significance_group[3], significance_group[4])))) %>% 
  mutate(tolabel = ifelse(significance == significance_group[1], hpo, ifelse(foldchange_asthma/foldchange_no_asthma  < 0.25 & significance != significance_group[4], hpo, "")))%>%
  ggplot() + geom_point(aes(x = foldchange_no_asthma, y = foldchange_asthma, shape = factor(significance, levels = significance_level), color = factor(significance, levels = significance_level), size = factor(significance, levels = significance_level))) + geom_text(aes(x = foldchange_no_asthma, y = foldchange_asthma, label = ""), size = 3, vjust = -1, hjust = -0.05) + coord_fixed(ratio = 1) + 
  scale_shape_manual(name = "", values = c(3, 4, 18, 16)) + scale_color_manual(name = "", values=c("red",  "blue", "orange", "black")) + scale_size_manual(name = "", values=c(3, 3, 2, 1)) +  xlab("HPO-dependent odds raio of being severe -asthma") + ylab("HPO-dependent odds raio of being severe +asthma") + theme_bw() + theme(panel.grid = element_blank(), legend.position = "none", legend.background = element_blank()) + geom_abline(intercept = 0, slope = 1, size = 0.5, color = "gray") + scale_y_continuous(limits = c(0, 50)) + scale_x_continuous(limits = c(0, 50))

joined_data %>% na.omit() %>%  
  mutate(significance = ifelse(significe_asthma == "Y" & significance_no_asthma == "N", significance_group[1], ifelse(significe_asthma == "N" & significance_no_asthma == "Y", significance_group[2], ifelse(significe_asthma == "Y" & significance_no_asthma == "Y", significance_group[3], significance_group[4])))) %>% 
  mutate(tolabel = ifelse(significance == significance_group[1], hpo, ifelse(foldchange_asthma/foldchange_no_asthma  < 0.25 & significance != significance_group[4], hpo, "")))%>%
  ggplot() + geom_point(aes(x = foldchange_no_asthma, y = foldchange_asthma, shape = factor(significance, levels = significance_level), color = factor(significance, levels = significance_level), size = factor(significance, levels = significance_level))) + 
  geom_text(aes(x = foldchange_no_asthma, y = foldchange_asthma, label = tolabel), size = 4, vjust = -1, hjust = -0.05) + coord_fixed(ratio = 1) + 
  scale_shape_manual(name = "significance", values = c(3, 4, 18, 16)) + scale_color_manual(name = "significance", values=c("red",  "blue", "orange", "black")) + scale_size_manual(name = "significance", values=c(3, 3, 2, 1)) +  xlab("HPO-dependent odds raio of being severe -asthma") + ylab("HPO-dependent odds raio of being severe +asthma") + theme_bw() + 
  theme(panel.grid = element_blank(), legend.position = c(0.2, 0.85), legend.background = element_blank(), axis.text = element_text(size = 8), axis.title = element_text(size = 10), panel.border = element_rect(size = 1), legend.text = element_text(size = 10), legend.title = element_text(size = 10)) + geom_abline(intercept = 0, slope = 1, size = 0.5, color = "gray") + scale_y_continuous(limits = c(0, 10)) + scale_x_continuous(limits = c(0, 10))

ggsave("~/Desktop/likehood ratio.png", width = 4.5, height = 4.5)
```

Build a predictive model for asthma severity

```{r}
selectedFeatures <- joined_data %>% filter(significe_asthma == "Y" | significance_no_asthma == "Y")
selectedFeatures <- selectedFeatures$hpo
df4ML_selected <- df4ML[,c("patient_num","sex_cd", "age", "encounter_no_days",selectedFeatures, "prscbCount")]
dim(df4ML_selected) # 13660, 45

df4ML_selected$sex_cd = as.factor(df4ML_selected$sex_cd)
df4ML_selected <- df4ML_selected %>% mutate(isSevere = ifelse(prscbCount >= SEVERITY_THRESHOLD, 1, 0)) %>% select(-prscbCount)
df4ML_selected$isSevere = as.factor(df4ML_selected$isSevere)
```


```{r}
require(caret)
#df4ML_selected <- na.omit(df4ML_selected)
rownames(df4ML_selected) = df4ML_selected$patient_num
df4ML_selected$patient_num = NULL
```

create dummy vars for sex
```{r}
target.index = ncol(df4ML_selected)
dmy <- dummyVars(~ ., data = df4ML_selected[,-target.index])
df4ML_dmy <- predict(dmy, df4ML_selected[,-target.index])

oldcolnames <- colnames(df4ML_dmy)
newcolnames <- vector(mode = "character")
for (i in 1:length(oldcolnames)){
  newcolnames[i] = paste("col", i, sep = "")
}
colnames(df4ML_dmy) <- newcolnames
impute <- preProcess(as.data.frame(df4ML_dmy), method = "bagImpute")
df4ML_dmy_imputed <- predict(impute, df4ML_dmy)
df4ML_dmy <- df4ML_dmy_imputed

df4ML_dmy <- as.data.frame(df4ML_dmy)
df4ML_dmy$isSevere <- df4ML_selected$isSevere
```

partation data into training and testing, ratio = 0.7
```{r}
indexes <- createDataPartition(df4ML_dmy$isSevere, p = 0.7, list = FALSE)
training <- df4ML_dmy[indexes,]
testing <- df4ML_dmy[-indexes,]
```

test support vector machine
```{r}

train.ctrl = trainControl(method = "repeatedcv", number = 10, repeats = 3)
#gridtune = expand.grid()

model <- train(training[,-target.index], training$isSevere, method = "bayesglm", trControl = train.ctrl)

prediction <- predict(model, testing[,-target.index])
cm <- confusionMatrix(prediction, testing$isSevere)
cm

train.ctrl.rf = trainControl(method = "repeatedcv", number = 10, repeats = 3, search = "grid")
tunegrid <- expand.grid(.mtry = seq(1, 15, 3))
c1 <- makeCluster(3, type = "SOCK")
registerDoSNOW(c1)
model_rf <- train(training[,-target.index], training$isSevere, method = "rf", trControl = train.ctrl.rf, tuneGrid = tunegrid)
model_rf
prediction <- predict(model_rf, testing[,-target.index])
confusionMatrix(prediction, testing$isSevere)
```



Disconnect database
```{r}
dbDisconnect(db)
```



